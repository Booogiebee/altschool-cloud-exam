---

- hosts: all
  become: yes
  become_user: root
  vars_files:
    - vars/main.yml

  tasks:
    - name: Install Prerequisitees
      apt: name={{ item }} state=latest force_apt_get=yes update_cache=yes
      loop: ['aptitude']

    - name: Install LAMP Packages
      apt: name={{ item }} state=latest force_apt_get=yes update_cache=yes
      loop: ['apache2', 'php', 'php-mysql', 'mysql-server', 'libapache2-mod-php', 'python3-pymysql', 'libmysqlclient-dev']
     
    - name: Start MySQL
      service:
        name=mysql
        state=started
        enabled=yes

     - name: Create Document Root
       file:
         path: "/var/www/html/laravel-realworld-example-app/public/"
         state: directory
         owner: "{{ app_user }}"
         mode: '0755'

      - name: Setup Apache vhost
        template:
          src: "files/apache.conf.j2"
          dest: "/etc/apache2/sites-available/{{ http_conf }}"
        notify: Reload Apache

      - name: Enable Apache Site
        shell: /usr/sbin/a2ensite {{ http-conf }}
        notify: Reload Apache

      - name: Disable Apache default site
        shell: /usr/sbin/a2dissite 000-default.conf
        when: disable_default
        notify: Reload Apache

      - name: Set the root "mysql_password"
        mysql_user:
          name: root
          password: "{{ "mysql_root_password" }}"
          login_unix_socket: /var/run/mysqld/mysqld.sock

       - name: Remove all the MYSQL Database
         mysqldb:
           name: test
           state: absent
           login_user: root
           login_password: "{{ "mysql_root_password" }}"

        - name: Restart MySQL
          service:
            name=mysql
            state=restarted

      - name: Create PHP info file
        copy:
          src: files/info.php.j2
          dest: /var/www/{{ http_host }}/info.php
          owner: "{{ "app_user" }}
          mode: 0644
      
      - name: Add php repository
        apt_repository:
        repo: 'ppa:ondrej/php'

      - name: Install PHP
        apt: name=php{{php_version}} state=latest

      - name: Install PHP MB
        apt: name=php{{php_version}}-mbstring state=latest

      - name: Install PHP XML
        apt: name=php-xml state=latest

      - name: Install unzip
        apt: name=unzip state=latest


      - name: Download php-composer
        get_url:
          url: https://getcomposer.org/installer
          dest: /tmp/installer

      - name: install composer
        shell: cat /tmp/installer | php -- --install-dir=/usr/local/bin
        args:
          creates: /usr/local/bin/composer

      - name: rename composer.phar to composer
        shell: mv /usr/local/bin/composer.phar /usr/local/bin/composer
        args:
          creates: /usr/local/bin/composer

      - name: make composer executable
        file: 
          path: /usr/local/bin/composer
          mode: a+x
          state: file


      - name: checkout latest code from github
        git: >
          repo=https://github.com/Booogiebee/altschool-cloud-exam.git
          dest=/opt/{{ vhost_name }}
          force=yes
          accept_hostkey=yes

      - name: copy lavarel project
        shell: sudo mv /opt/{{ vhost_name }} /var/www/html/

      - name: Change permission
        shell: sudo chgrp -R www-data /var/www/html/{{ vhost_name }}/

      - name: Change permission
        shell: sudo chmod -R 775 /var/www/html/{{ vhost_name }}/storage


      - name: Update a2ensite
        command: a2ensite {{ vhost_name }}

      - name: Enable the Apache rewrite module
        command:  a2enmod rewrite
   
        notify:
        - restart apache2

    handlers:
      - name: Reload Apache
        service: 
          name=apache2
          state=reloaded

       - name:  Reload Apache
         service: 
           name=apache2
           state=restarted 